{% extends "header_footer.html" %}
{% load static %}

{% block title %}Edit Your Profile{% endblock %}

{% block extra_css %}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
<style>
    /* --- THEME & COLORS --- */
    :root {
        --primary-green: #7fb51e;
        --light-gray: #e9e9e9;
        --medium-gray: #bdbdbd;
        --text-dark: #333;
        --background-page: #f9f9f9;
        --error-red: #dc3545;
        --success-green: #28a745;
    }

    /* --- Page & Form Wrapper --- */
    .edit-page-container {
        display: flex; justify-content: center; align-items: flex-start;
        padding: 5rem 1rem; width: 100%; background-color: var(--background-page);
    }
    .form-wrapper {
        background-color: #ffffff; padding: 2.5rem 3rem; border-radius: 20px;
        width: 100%; max-width: 800px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
        position: relative;
    }

    /* --- Form Title --- */
    .form-wrapper h2 {
        text-align: center; font-size: 2rem; font-weight: 400;color: #7fb51e;
        margin-top: 0; margin-bottom: 2.5rem;
    }

    /* --- General Form Layout --- */
    .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .grid-col-span-2 { grid-column: 1 / -1; }
    @media (max-width: 600px) { .grid-layout { grid-template-columns: 1fr; } }
    
    /* --- 
    !!! CRITICAL FIX !!!
    The old styles for .form-group (opacity, transform, z-index) were making the
    fields invisible and unclickable. They have been removed. This is the fix.
    --- */
    .form-group {
        position: relative; /* Still needed for error messages and other potential children */
    }
    
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    .form-group input, .form-group select {
        width: 100%; padding: 0 1rem; border: 1px solid #d1d1d1;
        border-radius: 8px; font-size: 1rem; background-color: #fdfdfd;
        box-sizing: border-box; height: 50px;
    }

    /* --- Section Styling (Fieldset & Legend) --- */
    fieldset {
        border: none; padding: 0; margin: 0;
        margin-top: 2.5rem;
        border-top: 1px solid var(--light-gray);
        padding-top: 2rem;
    }
    fieldset:first-of-type {
        border-top: none; margin-top: 0; padding-top: 0;
    }
    legend {
        padding: 0; width: 100%;
        font-size: 1.2rem; font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 1.5rem;
    }
    
    /* --- Password Field with Toggle Icon --- */
    .input-wrapper {
        position: relative;
        width: 100%;
    }
    .password-toggle {
        position: absolute; top: 0; right: 0;
        height: 100%; width: 45px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: var(--medium-gray); z-index: 2;
    }
    .input-wrapper input { padding-right: 45px; }

    /* --- Custom File Input --- */
    .file-upload-wrapper { position: relative; }
    .file-upload-label {
        display: flex; align-items: center; justify-content: center;
        height: 52px; border: 2px dashed var(--light-gray); border-radius: 8px;
        cursor: pointer; transition: all 0.2s ease;
    }
    .file-upload-label:hover { border-color: var(--primary-green); background-color: #f9f9f9; }
    #id_image { display: none; }
    .file-name { margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-dark); font-style: italic; display: block; }
    
    /* --- Read-Only Fields --- */
    .read-only-field {
        display: flex; align-items: center; box-sizing: border-box;
        height: 50px; background-color: #f0f0f0;
        padding: 0 1rem; border-radius: 8px;
        font-size: 1rem; color: #555; border: 1px solid #d1d1d1;
    }
    .field-note { font-size: 0.85rem; color: #666; margin-top: 0.5rem; }

    /* --- Messages & Buttons --- */
    .error-message { color: var(--error-red); font-size: 0.85rem; margin-top: 0.4rem; min-height: 1rem; }
    .is-invalid { border-color: var(--error-red) !important; }
    .success-message {
        text-align: center; padding: 1rem;
        background-color: #e8f5e9; color: var(--success-green);
        border: 1px solid var(--success-green); border-radius: 8px;
        margin-bottom: 1.5rem; display: none;
    }
    .btn-group { display: flex; gap: 1rem; margin-top: 2.5rem; }
    .btn { flex-grow: 1; padding: 1rem; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: bold; }
    .btn-save { background-color: var(--primary-green); color: white; }

    /* --- Loader --- */
    .loader-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(255, 255, 255, 0.8); border-radius: 20px;
        display: none; justify-content: center; align-items: center; z-index: 10;
    }
    .loader {
        border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-green);
        border-radius: 50%; width: 50px; height: 50px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<div class="edit-page-container">
    <div class="form-wrapper">
        <div class="loader-overlay" id="loader-overlay"><div class="loader"></div></div>

        <h2>Edit Your Profile</h2>

        <div id="success-message-box" class="success-message"></div>
        <div id="non-field-errors" class="error-message" style="text-align: center; margin-bottom: 1rem;"></div>

        <form method="post" id="edit-profile-form" action="{% url 'edit_profile' %}" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            <fieldset>
                <legend>Profile Information</legend>
                <div class="grid-layout">
                    <div class="form-group grid-col-span-2">
                        <label for="{{ profile_form.username.id_for_label }}">User Name</label>
                        {{ profile_form.username }}
                        <div class="error-message" data-field="username"></div>
                    </div>
                    <div class="form-group">
                        <label for="{{ profile_form.mobile_number.id_for_label }}">Mobile Number</label>
                        {{ profile_form.mobile_number }}
                        <div class="error-message" data-field="mobile_number"></div>
                    </div>
                    <div class="form-group">
                        <label for="{{ profile_form.date_of_birth.id_for_label }}">Date of Birth</label>
                        {{ profile_form.date_of_birth }}
                        <div class="error-message" data-field="date_of_birth"></div>
                    </div>
                     <div class="form-group">
                        <label>Profile Picture</label>
                        <div class="file-upload-wrapper">
                           <label for="{{ profile_form.image.id_for_label }}" class="file-upload-label">
                               <span class="file-label-text">Click to change image</span>
                           </label>
                           {{ profile_form.image }}
                           <span class="file-name" id="file-name-display">
                                {% if user.image %}{{ user.image.name|truncatechars:30 }}{% else %}No file chosen.{% endif %}
                           </span>
                        </div>
                        <div class="error-message" data-field="image"></div>
                    </div>
                    <div class="form-group">
                        <label for="{{ profile_form.gender.id_for_label }}">Gender</label>
                        {{ profile_form.gender }}
                        <div class="error-message" data-field="gender"></div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Account Information</legend>
                 <div class="grid-layout">
                    <div class="form-group">
                        <label for="{{ profile_form.email.id_for_label }}">Email Address</label>
                        {{ profile_form.email }}
                        <div class="field-note">Changing your email may require re-verification.</div>
                        <div class="error-message" data-field="email"></div>
                    </div>
                    <div class="form-group">
                        <label>Account Type</label>
                        <div class="read-only-field">{{ user.get_account_type_display }}</div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Change Password (leave blank to keep current password)</legend>
                <div class="grid-layout">
                    <div class="form-group grid-col-span-2">
                        <label for="{{ password_form.old_password.id_for_label }}">Old Password</label>
                        <div class="input-wrapper">
                            {{ password_form.old_password }}
                            <span class="password-toggle" data-target="{{ password_form.old_password.id_for_label }}"><i class="fas fa-eye"></i></span>
                        </div>
                        <div class="error-message" data-field="old_password"></div>
                    </div>
                    <div class="form-group">
                        <label for="{{ password_form.new_password1.id_for_label }}">New Password</label>
                        <div class="input-wrapper">
                            {{ password_form.new_password1 }}
                            <span class="password-toggle" data-target="{{ password_form.new_password1.id_for_label }}"><i class="fas fa-eye"></i></span>
                        </div>
                        <div class="error-message" data-field="new_password1"></div>
                    </div>
                    <div class="form-group">
                        <label for="{{ password_form.new_password2.id_for_label }}">Confirm New Password</label>
                        <div class="input-wrapper">
                            {{ password_form.new_password2 }}
                            <span class="password-toggle" data-target="{{ password_form.new_password2.id_for_label }}"><i class="fas fa-eye"></i></span>
                        </div>
                        <div class="error-message" data-field="new_password2"></div>
                    </div>
                </div>
            </fieldset>
            
            <div class="btn-group">
                <button type="submit" class="btn btn-save">Save Changes</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block js %}
<!-- The JavaScript is designed to work with the view and does not need changes. -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("edit-profile-form");
    const loader = document.getElementById("loader-overlay");
    const fileInput = document.getElementById("id_image");
    const fileNameDisplay = document.getElementById("file-name-display");
    const successMessageBox = document.getElementById("success-message-box");
    const nonFieldErrorsBox = document.getElementById("non-field-errors");

    const showLoader = () => loader.style.display = 'flex';
    const hideLoader = () => loader.style.display = 'none';
    const getCsrfToken = () => document.querySelector('[name=csrfmiddlewaretoken]').value;

    const clearMessages = () => {
        document.querySelectorAll(".error-message").forEach(el => el.textContent = "");
        document.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));
        nonFieldErrorsBox.textContent = '';
        nonFieldErrorsBox.style.display = 'none';
        successMessageBox.style.display = 'none';
    };
    
    const displayErrors = (errors) => {
        clearMessages();
        for (const field in errors) {
            const errorMsg = Array.isArray(errors[field]) ? errors[field][0] : errors[field];
            const errorDiv = document.querySelector(`.error-message[data-field="${field}"]`);
            
            if (errorDiv) {
                errorDiv.textContent = errorMsg;
                const inputElement = document.getElementById(`id_${field}`);
                if (inputElement) inputElement.classList.add('is-invalid');
            } else if (field === '__all__') {
                nonFieldErrorsBox.textContent = errorMsg;
                nonFieldErrorsBox.style.display = 'block';
            }
        }
    };

    const showSuccessMessage = (message) => {
        clearMessages();
        successMessageBox.textContent = message;
        successMessageBox.style.display = 'block';
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearMessages();
        showLoader();
        const formData = new FormData(form);

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken() },
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                showSuccessMessage('Profile updated successfully!');
                document.getElementById("id_old_password").value = "";
                document.getElementById("id_new_password1").value = "";
                document.getElementById("id_new_password2").value = "";
            } else {
                displayErrors(data.errors);
            }
        } catch (error) {
            console.error('Submission Error:', error);
            nonFieldErrorsBox.textContent = 'An unexpected error occurred. Please try again.';
            nonFieldErrorsBox.style.display = 'block';
        } finally {
            hideLoader();
            window.scrollTo({ top: form.offsetTop - 30, behavior: 'smooth' }); 
        }
    });

    if (fileInput) {
        fileInput.addEventListener("change", () => {
            fileNameDisplay.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : "No file chosen.";
        });
    }

    document.querySelectorAll('.password-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
            const targetId = toggle.dataset.target;
            const passwordInput = document.getElementById(targetId);
            const icon = toggle.querySelector('i');
            if (passwordInput && icon) {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            }
        });
    });
});
</script>
{% endblock %}